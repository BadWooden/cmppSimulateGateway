<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
    <bean id="serverManager" class="com.crazymouse.netty.server.impl.DefaultServerManager" init-method="startServers"
          destroy-method="stopServers">
        <property name="servers">
            <list>
                <ref bean="Cmpp20TcpServer"/>
                <ref bean="Cmpp30TcpServer"/>
            </list>
        </property>
    </bean>
    <!--空闲事件触发器-->
    <bean id="hashedWheelTimer" class="org.jboss.netty.util.HashedWheelTimer" scope="prototype"/>
    <!--数据统计线程-->
    <bean class="com.crazymouse.netty.handler.util.PerformanceThread" init-method="start" destroy-method="stop">
        <property name="period" value="5000"/>
        <property name="performance" ref="cmpp20Performance"/>
    </bean>
    <bean class="com.crazymouse.netty.handler.util.PerformanceThread" init-method="start" destroy-method="stop">
            <property name="period" value="5000"/>
            <property name="performance" ref="cmpp30Performance"/>
        </bean>
    <bean id="commPipelineFactory" class="com.crazymouse.netty.server.impl.CommPipelineFactory" abstract="true">
        <!--空闲事件触发器，如果不配置，idleCheckHandler可以去掉-->
        <property name="timer" ref="hashedWheelTimer"/>
        <property name="idleEventhandler" ref="idleCheckHandler"/>
        <property name="poolExecutor" ref="poolExecutor"/>
        <!--空闲时间，以秒为单位(默认为read writ 同时状态，read write有一种有数据时都不算空闲)-->
        <property name="idleTime" value="60"/>
    </bean>
    <!--cmpp20 Start-->
    <bean id="Cmpp20TcpServer" class="com.crazymouse.netty.server.impl.NettyTCPServer">
        <property name="serverName" value="Cmpp20Server"/>
        <property name="pipelineFactory" ref="cmpp20PipelineFactory"></property>
        <property name="portNumber" value="7890"></property>
    </bean>
    <bean id="cmpp20PipelineFactory" class="com.crazymouse.netty.server.impl.CommPipelineFactory" parent="commPipelineFactory">
        <property name="handlerMap">
            <map>
                <entry key="cmpp20Decode" value-ref="cmpp20Decode"/>
                <entry key="cmpp20ServerHandler" value-ref="cmpp20ServerHandler"/>
                <entry key="cmppEncode" value-ref="cmppEncode"/>
            </map>
        </property>
    </bean>
    <!--cmpp30 Start-->
    <bean id="Cmpp30TcpServer" class="com.crazymouse.netty.server.impl.NettyTCPServer">
        <property name="serverName" value="Cmpp30Server"/>
        <property name="pipelineFactory" ref="cmpp30PipelineFactory"></property>
        <property name="portNumber" value="7891"></property>
    </bean>
    <bean id="cmpp30PipelineFactory" class="com.crazymouse.netty.server.impl.CommPipelineFactory" parent="commPipelineFactory">
        <property name="handlerMap">
            <map>
                <entry key="cmpp30Decode" value-ref="cmpp30Decode"/>
                <entry key="cmpp30ServerHandler" value-ref="cmpp30ServerHandler"/>
                <entry key="cmppEncode" value-ref="cmppEncode"/>
            </map>
        </property>
    </bean>
    <!--消息处理线程池，单例模式，用于共享线程资源-->
    <bean id="poolExecutor" class="org.jboss.netty.handler.execution.MemoryAwareThreadPoolExecutor">
        <!--线程数 一般对应cpu 核心数-->
        <constructor-arg index="0" value="8"/>
        <!--channel最大内存-->
        <constructor-arg index="1" value="0"/>
        <!--总内存大小 防止内存溢出-->
        <constructor-arg index="2" value="0"/>
    </bean>
</beans>
